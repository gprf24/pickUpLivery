{% extends "base.html" %}
{% block content %}
<h2>Admin Panel</h2>

<!-- Users -->
<section>
  <h3>Users</h3>
  <form method="post" action="/admin/users/create">
    <label>Email <input type="email" name="email" required></label>
    <label>Full Name <input type="text" name="full_name"></label>
    <label>Password <input type="password" name="password" required></label>
    <label>Role
      <select name="role">
        <option value="driver">Driver</option>
        <option value="admin">Admin</option>
      </select>
    </label>
    <button type="submit">➕ Add User</button>
  </form>

  <table>
    <thead>
      <tr><th>Email</th><th>Name</th><th>Role</th><th>Status</th><th>Actions</th></tr>
    </thead>
    <tbody>
      {% for u in users %}
        <tr>
          <td>{{ u.email }}</td>
          <td>{{ u.full_name or "-" }}</td>
          <td>{{ u.role }}</td>
          <td>{{ "Active" if u.is_active else "Blocked" }}</td>
          <td>
            <form method="post" action="/admin/users/{{ u.id }}/toggle" style="display:inline;">
              <button type="submit">{{ "Block" if u.is_active else "Unblock" }}</button>
            </form>
            <form method="post" action="/admin/users/{{ u.id }}/set-role" style="display:inline;">
              <select name="role">
                <option value="driver" {% if u.role=="driver" %}selected{% endif %}>Driver</option>
                <option value="admin" {% if u.role=="admin" %}selected{% endif %}>Admin</option>
              </select>
              <button type="submit">Set</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<hr>

<!-- Regions -->
<section>
  <h3>Regions</h3>
  <form method="post" action="/admin/regions/create">
    <label>Name <input type="text" name="name" required></label>
    <label>Code <input type="text" name="code"></label>
    <button type="submit">➕ Add Region</button>
  </form>

  <ul>
    {% for r in regions %}
      <li>{{ r.name }} ({{ r.code or "-" }})</li>
    {% endfor %}
  </ul>
</section>

<hr>

<!-- Pharmacies -->
<section>
  <h3>Pharmacies</h3>
  <form method="post" action="/admin/pharmacies/create">
    <label>Name <input type="text" name="name" required></label>
    <label>Address <input type="text" name="address"></label>
    <label>Region
      <select name="region_id">
        <option value="">-</option>
        {% for r in regions %}
          <option value="{{ r.id }}">{{ r.name }}</option>
        {% endfor %}
      </select>
    </label>
    <button type="submit">➕ Add Pharmacy</button>
  </form>

  <table>
    <thead>
      <tr><th>Name</th><th>Region</th><th>Address</th><th>Drivers</th><th>Assign</th></tr>
    </thead>
    <tbody>
      {% for ph in pharmacies %}
        <tr>
          <td>{{ ph.name }}</td>
          <td>
            {% for r in regions if r.id==ph.region_id %}{{ r.name }}{% endfor %}
          </td>
          <td>{{ ph.address or "-" }}</td>
          <td>
            {% for l in links if l.pharmacy_id==ph.id %}
              {% for u in users if u.id==l.user_id %}
                {{ u.email }},
              {% endfor %}
            {% endfor %}
          </td>
          <td>
            <form method="post" action="/admin/pharmacies/{{ ph.id }}/assign" style="display:inline;">
              <select name="driver_id">
                {% for u in users if u.role=="driver" %}
                  <option value="{{ u.id }}">{{ u.email }}</option>
                {% endfor %}
              </select>
              <button type="submit">Assign</button>
            </form>
            <form method="post" action="/admin/pharmacies/{{ ph.id }}/unassign" style="display:inline;">
              <select name="driver_id">
                {% for u in users if u.role=="driver" %}
                  <option value="{{ u.id }}">{{ u.email }}</option>
                {% endfor %}
              </select>
              <button type="submit">Unassign</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endblock %}
