{# templates/pickup.html #}
{% extends "base.html" %}
{% block title %}Pickup â€” {{ pharmacy.name if pharmacy else 'Unknown Pharmacy' }}{% endblock %}

{% block content %}
{# Safe fallback: if setting is None, use 1 #}
{% set min_photos = (min_required_photos if min_required_photos is not none else 1) %}
{% set is_admin = (user.role == "admin") %}
{# How many slots should visually show "Required" #}
{% set required_slots = 4 if min_photos > 4 else min_photos %}

<section class="page-hero">
  <h2 class="page-title">Pickup at {{ pharmacy.name }}</h2>
  <p class="lead">
    Take photos one-by-one into four slots.
    At least {{ min_photos }} photo{{ 's' if min_photos != 1 else '' }} is required.
  </p>
</section>

<a href="/tasks" class="btn btn-secondary">Back to tasks</a>

<section class="card pickup-card">
  {% if message %}
    <div class="alert alert-ok success-msg" role="status">{{ message }}</div>
  {% endif %}
  {% if error %}
    <div class="alert alert-error error-msg" role="alert">{{ error }}</div>
  {% endif %}

  <form id="pickupForm"
        class="form-grid pickup-form"
        action="/pickup/{{ pharmacy.public_id }}"
        method="post"
        enctype="multipart/form-data">

    {# ------------------ Location row: button + lat/lon in one line ------------------ #}
    {% if is_admin %}
      {# ADMIN: can type coordinates manually #}
      <div class="pickup-location-row">
        <button type="button" class="btn btn-primary" id="btnLocate">
          <span class="spinner" id="locSpinner" hidden></span>
          Use current location
        </button>

        <label class="form-label inline-label">
          Lat
          <input
            type="text"
            name="lat"
            id="lat"
            class="form-input form-input-compact"
            placeholder="53.55"
            {% if require_location %}required{% endif %}
          >
        </label>

        <label class="form-label inline-label">
          Lon
          <input
            type="text"
            name="lon"
            id="lon"
            class="form-input form-input-compact"
            placeholder="9.99"
            {% if require_location %}required{% endif %}
          >
        </label>
      </div>

      <div class="pickup-location-meta">
        <small class="muted pickup-note">
          {% if require_location %}
            Location is <strong>required</strong> for this pickup.
            You can enter it manually or use the button.
          {% else %}
            Location is optional but recommended to improve traceability.
          {% endif %}
        </small>
        <small id="locStatus" class="muted pickup-loc-status" aria-live="polite"></small>
      </div>
    {% else %}
      {# DRIVER: cannot type coordinates manually; only via geolocation button #}
      <div class="pickup-location-row">
        <button type="button" class="btn btn-primary" id="btnLocate">
          <span class="spinner" id="locSpinner" hidden></span>
          Use current location
        </button>

        <label class="form-label inline-label">
          Lat
          <input
            type="text"
            id="lat_display"
            class="form-input form-input-compact"
            placeholder="Press button"
            readonly
          >
        </label>

        <label class="form-label inline-label">
          Lon
          <input
            type="text"
            id="lon_display"
            class="form-input form-input-compact"
            placeholder="Press button"
            readonly
          >
        </label>
      </div>

      {# real hidden fields that are submitted to the backend #}
      <input type="hidden" name="lat" id="lat">
      <input type="hidden" name="lon" id="lon">

      <div class="pickup-location-meta">
        <small class="muted pickup-note">
          {% if require_location %}
            Location is <strong>required</strong> for this pickup. Please use the button to fill it automatically.
          {% else %}
            Location is optional but recommended to improve traceability.
          {% endif %}
        </small>
        <small id="locStatus" class="muted pickup-loc-status" aria-live="polite"></small>
      </div>
    {% endif %}

    <!-- Four distinct photo slots -->
    <div class="photo-slots">
      <!-- Slot 1 -->
      <div class="slot">
        <label class="slot-label">
          <div class="slot-header">
            <span class="slot-title">Photo slot 1</span>
            {% if required_slots >= 1 %}
              <span class="slot-badge slot-badge-required">Required</span>
            {% else %}
              <span class="slot-badge">Optional</span>
            {% endif %}
          </div>

          <div class="file-input-row">
            <span class="file-icon" aria-hidden="true">ðŸ“·</span>
            <div class="file-texts">
              <span class="file-main-text">Tap to take or upload photo</span>
              <span class="slot-filename" data-empty="No file selected">No file selected</span>
            </div>
          </div>

          <input
            type="file"
            name="image1"
            id="image1"
            accept="image/*"
            {% if photo_source_mode == 'camera_only' %}capture="environment"{% endif %}
            class="slot-input"
          >

          <small class="muted">
            Counts towards the minimum of {{ min_photos }} photo{{ 's' if min_photos != 1 else '' }}.
          </small>
        </label>

        <div class="slot-preview" id="preview1" aria-live="polite"></div>
      </div>

      <!-- Slot 2 -->
      <div class="slot">
        <label class="slot-label">
          <div class="slot-header">
            <span class="slot-title">Photo slot 2</span>
            {% if required_slots >= 2 %}
              <span class="slot-badge slot-badge-required">Required</span>
            {% else %}
              <span class="slot-badge">Optional</span>
            {% endif %}
          </div>

          <div class="file-input-row">
            <span class="file-icon" aria-hidden="true">ðŸ“·</span>
            <div class="file-texts">
              <span class="file-main-text">Tap to take or upload photo</span>
              <span class="slot-filename" data-empty="No file selected">No file selected</span>
            </div>
          </div>

          <input
            type="file"
            name="image2"
            id="image2"
            accept="image/*"
            {% if photo_source_mode == 'camera_only' %}capture="environment"{% endif %}
            class="slot-input"
          >

          <small class="muted">Optional.</small>
        </label>

        <div class="slot-preview" id="preview2" aria-live="polite"></div>
      </div>

      <!-- Slot 3 -->
      <div class="slot">
        <label class="slot-label">
          <div class="slot-header">
            <span class="slot-title">Photo slot 3</span>
            {% if required_slots >= 3 %}
              <span class="slot-badge slot-badge-required">Required</span>
            {% else %}
              <span class="slot-badge">Optional</span>
            {% endif %}
          </div>

          <div class="file-input-row">
            <span class="file-icon" aria-hidden="true">ðŸ“·</span>
            <div class="file-texts">
              <span class="file-main-text">Tap to take or upload photo</span>
              <span class="slot-filename" data-empty="No file selected">No file selected</span>
            </div>
          </div>

          <input
            type="file"
            name="image3"
            id="image3"
            accept="image/*"
            {% if photo_source_mode == 'camera_only' %}capture="environment"{% endif %}
            class="slot-input"
          >

          <small class="muted">Optional.</small>
        </label>

        <div class="slot-preview" id="preview3" aria-live="polite"></div>
      </div>

      <!-- Slot 4 -->
      <div class="slot">
        <label class="slot-label">
          <div class="slot-header">
            <span class="slot-title">Photo slot 4</span>
            {% if required_slots >= 4 %}
              <span class="slot-badge slot-badge-required">Required</span>
            {% else %}
              <span class="slot-badge">Optional</span>
            {% endif %}
          </div>

          <div class="file-input-row">
            <span class="file-icon" aria-hidden="true">ðŸ“·</span>
            <div class="file-texts">
              <span class="file-main-text">Tap to take or upload photo</span>
              <span class="slot-filename" data-empty="No file selected">No file selected</span>
            </div>
          </div>

          <input
            type="file"
            name="image4"
            id="image4"
            accept="image/*"
            {% if photo_source_mode == 'camera_only' %}capture="environment"{% endif %}
            class="slot-input"
          >

          <small class="muted">Optional.</small>
        </label>

        <div class="slot-preview" id="preview4" aria-live="polite"></div>
      </div>
    </div>

    <div class="form-actions pickup-submit-row">
      <button type="submit" class="btn btn-primary">Submit pickup</button>
      <a href="/tasks" class="btn btn-secondary">Back to tasks</a>
    </div>
  </form>
</section>
{% endblock %}

{% block scripts %}
<script>
  // pass backend flags into JS
  const REQUIRE_LOCATION = {{ 'true' if require_location else 'false' }};
  const IS_ADMIN = {{ 'true' if user.role == "admin" else 'false' }};
  const MIN_REQUIRED_PHOTOS = {{ (min_required_photos if min_required_photos is not none else 1) | int }};

  // ---------- per-slot preview + filename ----------
  function bindPreview(inputId, previewId) {
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    if (!input || !preview) return;

    input.addEventListener('change', () => {
      const slot = input.closest('.slot');
      const filenameEl = slot ? slot.querySelector('.slot-filename') : null;

      preview.innerHTML = '';

      const file = input.files && input.files[0];

      if (!file) {
        if (filenameEl) {
          const emptyText = filenameEl.dataset.empty || 'No file selected';
          filenameEl.textContent = emptyText;
        }
        return;
      }

      if (filenameEl) {
        filenameEl.textContent = file.name;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.alt = file.name || inputId;
        preview.appendChild(img);
      };
      reader.readAsDataURL(file);
    });
  }

  bindPreview('image1', 'preview1');
  bindPreview('image2', 'preview2');
  bindPreview('image3', 'preview3');
  bindPreview('image4', 'preview4');

  // ---------- require at least MIN_REQUIRED_PHOTOS photos (and location if enabled) ----------
  const form = document.getElementById('pickupForm');
  form?.addEventListener('submit', (e) => {
    const i1 = document.getElementById('image1');
    const i2 = document.getElementById('image2');
    const i3 = document.getElementById('image3');
    const i4 = document.getElementById('image4');

    const total =
      (i1?.files?.length || 0) +
      (i2?.files?.length || 0) +
      (i3?.files?.length || 0) +
      (i4?.files?.length || 0);

    if (total < MIN_REQUIRED_PHOTOS) {
      e.preventDefault();
      alert(`Please attach at least ${MIN_REQUIRED_PHOTOS} photo${MIN_REQUIRED_PHOTOS === 1 ? '' : 's'} (any slot).`);
      return false;
    }

    if (REQUIRE_LOCATION) {
      const latField = document.getElementById('lat');  // admin: visible, driver: hidden
      const lonField = document.getElementById('lon');
      const lat = latField?.value.trim();
      const lon = lonField?.value.trim();

      if (!lat || !lon) {
        e.preventDefault();
        const msg = IS_ADMIN
          ? 'Location is required. Please provide latitude and longitude (or use "Use current location").'
          : 'Location is required. Please use "Use current location".';
        alert(msg);
        return false;
      }
    }
  });

  // ---------- Geolocation ----------
  const btnLocate   = document.getElementById('btnLocate');
  const locSpinner  = document.getElementById('locSpinner');
  const locStatus   = document.getElementById('locStatus');
  const latField    = document.getElementById('lat');
  const lonField    = document.getElementById('lon');
  const latDisplay  = document.getElementById('lat_display');
  const lonDisplay  = document.getElementById('lon_display');

  function setLocStatus(msg){ if (locStatus) locStatus.textContent = msg || ''; }
  function setLoading(loading){
    if (locSpinner) locSpinner.hidden = !loading;
    if (btnLocate){
      btnLocate.disabled = loading;
      btnLocate.classList.toggle('is-loading', loading);
      if (loading) btnLocate.setAttribute('aria-busy','true'); else btnLocate.removeAttribute('aria-busy');
    }
  }
  const fmt = n => (typeof n === 'number' && isFinite(n)) ? n.toFixed(6) : '';

  function getPosition(options){
    return new Promise((resolve, reject) => {
      if (!('geolocation' in navigator)) {
        reject(new Error('Geolocation is not supported by this browser.'));
        return;
      }
      navigator.geolocation.getCurrentPosition(resolve, reject, options);
    });
  }

  btnLocate?.addEventListener('click', async () => {
    setLoading(true); setLocStatus('Locatingâ€¦');
    try{
      const pos = await getPosition({ enableHighAccuracy:true, timeout:10000, maximumAge:0 });
      const { latitude, longitude, accuracy } = pos.coords;
      const latStr = fmt(latitude);
      const lonStr = fmt(longitude);

      if (latField)   latField.value   = latStr;
      if (lonField)   lonField.value   = lonStr;
      if (latDisplay) latDisplay.value = latStr;
      if (lonDisplay) lonDisplay.value = lonStr;

      setLocStatus(`Location set (Â±${Math.round(accuracy)} m).`);
    }catch(err){
      let msg = 'Failed to get location.';
      if (err && typeof err.code === 'number'){
        if (err.code === 1) msg = 'Permission denied. Please allow location access.';
        else if (err.code === 2) msg = 'Position unavailable.';
        else if (err.code === 3) msg = 'Timed out while retrieving location.';
      } else if (err && err.message){ msg = err.message; }
      setLocStatus(msg);
    }finally{
      setLoading(false);
    }
  });
</script>
{% endblock %}
