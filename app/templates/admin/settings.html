{% extends "base.html" %}
{% block title %}Admin Settings · PickUp Livery{% endblock %}

{% block content %}
<section class="page-hero">
  <h2 class="page-title">Global settings</h2>
  <p class="lead">
    Configure pickup limits, GPS requirements and photo behaviour for the whole application.
  </p>
</section>

<section class="card settings-card">
  <form method="post" action="/admin/settings" class="form-grid">

    {# ----- MAX PICKUPS PER DAY ----- #}
    <label class="form-label">
      Max pickups per driver &amp; pharmacy per day
      <input
        type="number"
        class="form-input"
        name="allowed_pickups_per_day"
        min="1"
        value="{{ settings.allowed_pickups_per_day }}"
        required
      >
      <small class="muted">
        Applied per (driver, pharmacy) combination. When the limit is reached,
        new pickups will be rejected with HTTP 429.
      </small>
    </label>

    <div class="setting-divider"></div>

    {# ----- GLOBAL GPS REQUIREMENT ----- #}
    <label class="form-label checkbox-inline">
      <input
        type="checkbox"
        name="require_pickup_location_global"
        value="1"
        {% if settings.require_pickup_location_global %}checked{% endif %}
      >
      <div class="checkbox-text">
        <span class="checkbox-title">Require GPS location globally</span>
        <small class="muted">
          If enabled, location is required by default. Individual users can override this
          in their profile (Require GPS = yes/no/inherit).
        </small>
      </div>
    </label>

    <div class="setting-divider"></div>

    {# ----- SHOW HISTORY TO DRIVERS ----- #}
    <label class="form-label checkbox-inline">
      <input
        type="checkbox"
        name="show_history_to_drivers"
        value="1"
        {% if settings.show_history_to_drivers %}checked{% endif %}
      >
      <div class="checkbox-text">
        <span class="checkbox-title">Allow drivers to see history page</span>
        <small class="muted">
          If disabled, only admins will be able to open the history page.
          Drivers will receive a 403 error when trying to access it.
        </small>
      </div>
    </label>

    <div class="setting-divider"></div>

    {# ----- MIN REQUIRED PHOTOS ----- #}
    <label class="form-label">
      Minimal required photos per pickup
      <input
        type="number"
        class="form-input"
        name="min_required_photos"
        min="0"
        max="4"
        value="{{ settings.min_required_photos }}"
        required
      >
      <small class="muted">
        The backend enforces this value on submit. Frontend shows it on the pickup form
        and prevents sending fewer photos.
      </small>
    </label>

    <div class="setting-divider"></div>

    {# ----- PHOTO SOURCE MODE (CHIP DROPDOWN) ----- #}
    {% set current_mode = settings.photo_source_mode or 'camera_or_upload' %}

    <label class="form-label">
      Photo source mode

      <div class="chip-dropdown-wrapper photo-source-dropdown-wrapper">
        <button type="button" class="chip chip-dropdown">
          <span class="chip-main-text" style="min-width: 185px;">
            {% if current_mode == 'camera_only' %}
              Prefer camera only (mobile hint)
            {% else %}
              Camera or upload from device
            {% endif %}
          </span>
          <span class="chip-caret"></span>
        </button>

        <div class="dropdown-menu" style="max-width: 220px;">
          <button type="button"
                  class="dropdown-item {% if current_mode == 'camera_or_upload' %}is-active{% endif %}"
                  data-value="camera_or_upload">
            Camera or upload from device
          </button>
          <button type="button"
                  class="dropdown-item {% if current_mode == 'camera_only' %}is-active{% endif %}"
                  data-value="camera_only">
            Prefer camera only (mobile hint)
          </button>
        </div>

        <input type="hidden" name="photo_source_mode" value="{{ current_mode }}">
      </div>

      <small class="muted">
        “Camera only” is a best-effort hint using the <code>capture</code> attribute.
        It cannot fully forbid file uploads on all platforms.
      </small>
    </label>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">Save settings</button>
      <a href="/admin" class="btn btn-secondary">Back to admin</a>
    </div>

  </form>
</section>

{# Inline JS for chip dropdowns, same поведение как на admin page #}
<script>
  document.addEventListener("click", function (event) {
    const chip = event.target.closest(".chip-dropdown");
    if (chip) {
      const w = chip.closest(".chip-dropdown-wrapper");
      if (w) {
        w.classList.toggle("is-open");
      }
      return;
    }

    const item = event.target.closest(".chip-dropdown-wrapper .dropdown-item");
    if (item) {
      const w = item.closest(".chip-dropdown-wrapper");
      if (!w) return;

      const hidden = w.querySelector("input[type='hidden']");
      const label = w.querySelector(".chip-main-text");

      if (hidden) hidden.value = item.dataset.value;
      if (label) label.textContent = item.textContent.trim();

      w.querySelectorAll(".dropdown-item").forEach(function (b) {
        b.classList.toggle("is-active", b === item);
      });

      w.classList.remove("is-open");
      return;
    }

    if (!event.target.closest(".chip-dropdown-wrapper")) {
      document
        .querySelectorAll(".chip-dropdown-wrapper.is-open")
        .forEach(function (w) {
          w.classList.remove("is-open");
        });
    }
  });
</script>

{% endblock %}
