{% extends "base.html" %}
{% block title %}Admin · PickUp Livery{% endblock %}

{% block content %}
<section class="page-hero">
  <h1 class="page-title">Admin panel</h1>
  <p class="lead">
    Quick stats, user/region/pharmacy management — with per-user GPS settings and global config.
  </p>
  <div class="g-actions">
    <a href="/admin/settings" class="btn btn-secondary">Global settings</a>
  </div>
</section>

<section class="admin-glass">

  <!--======= STATISTICS =======-->
  <details class="g-section" data-section-id="admin-stats" open>
    <summary>
      <h2>Statistics</h2>
    </summary>
    <ul class="g-badges">
      <li class="badge">Users: {{ stats.counts.users or 0 }}</li>
      <li class="badge">Regions: {{ stats.counts.regions or 0 }}</li>
      <li class="badge">Pharmacies: {{ stats.counts.pharmacies or 0 }}</li>
      <li class="badge">Pickups: {{ stats.counts.pickups or 0 }}</li>
      <li class="badge">Links: {{ stats.counts.user_pharmacy_links or 0 }}</li>
      <li class="badge">Photos: {{ stats.counts.pickup_photos or 0 }}</li>
      <li class="badge">App settings rows: {{ stats.counts.app_settings or 0 }}</li>
    </ul>
  </details>

  <!--======= USERS =======-->
  <details class="g-section" data-section-id="admin-users">
    <summary>
      <h2>Users ({{ stats.counts.users or 0 }})</h2>
    </summary>

    <!-- Create user -->
    <div class="g-card">
      <h3 class="g-subtitle">Create user</h3>

      <form
        action="/admin/users/create"
        method="post"
        class="form-grid js-ajax-form"
        data-admin-action="user-create"
      >
        <label class="form-label">
          Login
          <input type="text" name="login" required class="form-input">
        </label>

        <label class="form-label">
          Password
          <input type="password" name="password" required minlength="6" class="form-input">
        </label>

        <label class="form-label">
          Role
          <div class="chip-dropdown-wrapper role-dropdown-wrapper">
            <button type="button" class="chip chip-dropdown">
              <span class="chip-main-text">Driver</span>
              <span class="chip-caret"></span>
            </button>

            <div class="dropdown-menu">
              <!-- Default: Driver is selected -->
              <button type="button" class="dropdown-item is-active" data-value="driver">
                Driver
              </button>
              <button type="button" class="dropdown-item" data-value="admin">
                Admin
              </button>
              <!-- History-only role -->
              <button type="button" class="dropdown-item" data-value="history">
                History only
              </button>
            </div>

            <!-- Hidden field updated by JS chip-dropdown logic -->
            <input type="hidden" name="role" value="driver">
          </div>
        </label>

        <label class="form-label checkbox-inline">
          <input type="checkbox" name="require_pickup_location" value="1" checked>
          <div class="checkbox-text">
            <span class="checkbox-title">Require GPS location</span>
            <small class="muted">
              If checked → always require GPS. If unchecked → inherit global setting.
            </small>
          </div>
        </label>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>

    <!-- User list -->
    <div class="g-card">
      <h3 class="g-subtitle">Existing users</h3>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Login</th>
              <th>Role</th>
              <th>Active</th>
              <th>Require GPS</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            {% for u in users %}
            <tr data-user-id="{{ u.id }}">
              <td>{{ u.id }}</td>
              <td>{{ u.login }}</td>

              <td>
                {% if u.role == 'admin' %}
                  Admin
                {% elif u.role == 'driver' %}
                  Driver
                {% elif u.role == 'history' %}
                  History only
                {% else %}
                  {{ u.role }}
                {% endif %}
              </td>

              <!-- Active pill -->
              <td>
                {% if u.is_active %}
                  <span class="status-pill status-ok">Yes</span>
                {% else %}
                  <span class="status-pill">No</span>
                {% endif %}
              </td>

              <!-- GPS MODE -->
              <td>
                <div class="user-gps-block">

                  {% set current_gps_mode =
                      'inherit' if u.require_pickup_location is none
                      else 'require' if u.require_pickup_location
                      else 'no'
                  %}

                  <form
                    action="/admin/users/{{ u.id }}/gps"
                    method="post"
                    class="gps-inline-form js-ajax-form"
                    data-admin-action="user-gps-update"
                  >
                    <div class="chip-dropdown-wrapper gps-mode-wrapper">
                      <button type="button" class="chip chip-dropdown chip-gps">
                        <span class="chip-main-text">
                          {% if current_gps_mode == 'inherit' %}
                            Inherit global
                          {% elif current_gps_mode == 'require' %}
                            Require GPS
                          {% else %}
                            GPS not required
                          {% endif %}
                        </span>
                        <span class="chip-caret"></span>
                      </button>

                      <div class="dropdown-menu">
                        <button type="button"
                                class="dropdown-item {% if current_gps_mode == 'inherit' %}is-active{% endif %}"
                                data-value="inherit">
                          Inherit global
                        </button>
                        <button type="button"
                                class="dropdown-item {% if current_gps_mode == 'require' %}is-active{% endif %}"
                                data-value="require">
                          Require GPS
                        </button>
                        <button type="button"
                                class="dropdown-item {% if current_gps_mode == 'no' %}is-active{% endif %}"
                                data-value="no">
                          GPS not required
                        </button>
                      </div>

                      <input type="hidden" name="gps_mode" value="{{ current_gps_mode }}">
                    </div>

                    <button type="submit" class="btn btn-secondary btn-sm-inline">Update</button>
                  </form>
                </div>
              </td>

              <!-- ACTIONS -->
              <td>
                <div class="form-actions form-actions-row">

                  <!-- Change password -->
                  <form
                    action="/admin/users/{{ u.id }}/password"
                    method="post"
                    class="form-grid js-ajax-form"
                    data-admin-action="user-password-change"
                  >
                    <input type="password" name="new_password" placeholder="new password" minlength="6" required class="form-input">
                    <button type="submit" class="btn btn-primary">Set</button>
                  </form>

                  <!-- Toggle active -->
                  <form
                    action="/admin/users/{{ u.id }}/toggle-active"
                    method="post"
                    class="js-ajax-form"
                    data-admin-action="user-toggle-active"
                  >
                    <button type="submit" class="btn btn-secondary btn-toggle">
                      {{ 'Deactivate' if u.is_active else 'Activate' }}
                    </button>
                  </form>

                  <hr class="newdevider" />

                  <!-- Delete user -->
                  <form
                    action="/admin/users/{{ u.id }}/delete"
                    method="post"
                    class="js-ajax-form"
                    data-admin-action="user-delete"
                    onsubmit="return confirm('Delete user {{ u.login }}? This cannot be undone.');"
                  >
                    <button type="submit" class="btn btn-primary btn-danger">Delete</button>
                  </form>

                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    </div>
  </details>

  <!--======== REGIONS ========-->
  <details class="g-section" data-section-id="admin-regions">
    <summary>
      <h2>Regions ({{ stats.counts.regions or 0 }})</h2>
    </summary>

    <div class="g-card">
      <h3 class="g-subtitle">Create region</h3>

      <form
        action="/admin/regions/create"
        method="post"
        class="form-grid js-ajax-form"
        data-admin-action="region-create"
      >
        <label class="form-label">
          Name
          <input type="text" name="name" required class="form-input">
        </label>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>

    <div class="g-card">
      <h3 class="g-subtitle">All regions</h3>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Active</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            {% for r in regions %}
            <tr data-region-id="{{ r.id }}">
              <td>{{ r.id }}</td>
              <td>{{ r.name }}</td>

              <td>
                {% if r.is_active %}
                  <span class="status-pill status-ok">Yes</span>
                {% else %}
                  <span class="status-pill">No</span>
                {% endif %}
              </td>

              <td>
                <div class="form-actions form-actions-row">

                  <!-- toggle -->
                  <form
                    action="/admin/regions/{{ r.id }}/toggle"
                    method="post"
                    class="js-ajax-form"
                    data-admin-action="region-toggle-active"
                  >
                    <button type="submit" class="btn btn-secondary btn-toggle">
                      {{ 'Deactivate' if r.is_active else 'Activate' }}
                    </button>
                  </form>

                  <hr class="newdevider" />

                  <!-- delete -->
                  <form
                    action="/admin/regions/{{ r.id }}/delete"
                    method="post"
                    class="js-ajax-form"
                    data-admin-action="region-delete"
                    onsubmit="return confirm('Delete region {{ r.name }}? This cannot be undone.');"
                  >
                    <button type="submit" class="btn btn-primary btn-danger">Delete</button>
                  </form>

                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    </div>
  </details>

  <!--======== PHARMACIES ========-->
  <details class="g-section" data-section-id="admin-pharmacies">
    <summary>
      <h2>Pharmacies ({{ stats.counts.pharmacies or 0 }})</h2>
    </summary>

    <div class="g-card">
      <h3 class="g-subtitle">Create pharmacy</h3>

      {% set default_region_id = regions[0].id if regions else '' %}
      {% set default_region_name = regions[0].name if regions else 'No regions' %}

      <form
        action="/admin/pharmacies/create"
        method="post"
        class="form-grid js-ajax-form"
        data-admin-action="pharmacy-create"
      >

        <label class="form-label">
          Name
          <input type="text" name="name" required class="form-input">
        </label>

        <label class="form-label">
          Region
          <div class="chip-dropdown-wrapper region-dropdown-wrapper">
            <button type="button" class="chip chip-dropdown">
              <span class="chip-main-text">{{ default_region_name }}</span>
              <span class="chip-caret"></span>
            </button>

            <div class="dropdown-menu" style="max-width: 220px;">
              {% for r in regions %}
              <button type="button" class="dropdown-item {% if loop.first %}is-active{% endif %}"
                      data-value="{{ r.id }}">
                {{ r.name }}
              </button>
              {% endfor %}
            </div>

            <input type="hidden" name="region_id" value="{{ default_region_id }}">
          </div>
        </label>

        <label class="form-label">
          Address
          <input type="text" name="address" class="form-input" placeholder="optional">
        </label>

        <label class="form-label">
          Default weekday cutoff (local)
          <input
            type="time"
            name="default_weekday_cutoff_local"
            class="form-input"
            placeholder="HH:MM"
          >
          <small class="muted">
            Optional. Local time (Europe/Berlin). Can be applied as Mon–Fri cutoff after creation.
          </small>
        </label>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>

    <div class="g-card">
      <h3 class="g-subtitle">All pharmacies</h3>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Region</th>
              <th>Active</th>
              <th>Cutoff times (local)</th>
              <th>Assigned users</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            {% for p in pharmacies %}
            <tr data-pharmacy-id="{{ p.id }}">
              <td>{{ p.id }}</td>
              <td>{{ p.name }}</td>
              <td>
                {{ region_by_id.get(p.region_id).name if region_by_id.get(p.region_id) else '-' }}
              </td>

              <td>
                {% if p.is_active %}
                  <span class="status-pill status-ok">Yes</span>
                {% else %}
                  <span class="status-pill">No</span>
                {% endif %}
              </td>

              <!-- Weekly cutoff times summary + modal trigger -->
              <td>
                <div class="pharmacy-cutoff-summary">
                  <div class="pharmacy-cutoff-summary-text muted">
                    Mon {% if p.cutoff_mon_local %}{{ p.cutoff_mon_local.strftime('%H:%M') }}{% else %}—{% endif %},
                    Tue {% if p.cutoff_tue_local %}{{ p.cutoff_tue_local.strftime('%H:%M') }}{% else %}—{% endif %},
                    Wed {% if p.cutoff_wed_local %}{{ p.cutoff_wed_local.strftime('%H:%M') }}{% else %}—{% endif %},
                    Thu {% if p.cutoff_thu_local %}{{ p.cutoff_thu_local.strftime('%H:%M') }}{% else %}—{% endif %},
                    Fri {% if p.cutoff_fri_local %}{{ p.cutoff_fri_local.strftime('%H:%M') }}{% else %}—{% endif %},
                    Sat {% if p.cutoff_sat_local %}{{ p.cutoff_sat_local.strftime('%H:%M') }}{% else %}—{% endif %},
                    Sun {% if p.cutoff_sun_local %}{{ p.cutoff_sun_local.strftime('%H:%M') }}{% else %}—{% endif %}
                  </div>
                  <button
                    type="button"
                    class="btn btn-secondary btn-xs js-open-cutoff-modal"
                    data-pharmacy-id="{{ p.id }}"
                  >
                    Edit
                  </button>
                </div>

                <!-- Cutoff modal (backdrop) -->
                <div class="cutoff-modal-backdrop" data-cutoff-modal="{{ p.id }}" hidden>
                  <div class="cutoff-modal" role="dialog" aria-modal="true" aria-label="Edit cutoff times">
                    <div class="cutoff-modal-header">
                      <h4>Cutoff times – {{ p.name }}</h4>
                      <button type="button" class="cutoff-modal-close js-close-cutoff-modal" aria-label="Close">×</button>
                    </div>

                    <div class="cutoff-modal-body">
                      <p class="muted">
                        Local times (Europe/Berlin). Courier is late if pickup is created after the cutoff.
                      </p>

                      <form
                        action="/admin/pharmacies/{{ p.id }}/cutoffs"
                        method="post"
                        class="js-ajax-form pharmacy-cutoffs-form"
                        data-admin-action="pharmacy-cutoffs-update"
                      >
                        <div class="cutoffs-grid">
                          <div class="cutoff-row">
                            <span class="cutoff-label">Mon</span>
                            <input
                              type="time"
                              name="mon"
                              class="form-input form-input-sm"
                              value="{{ p.cutoff_mon_local.strftime('%H:%M') if p.cutoff_mon_local else '' }}"
                            >
                          </div>
                          <div class="cutoff-row">
                            <span class="cutoff-label">Tue</span>
                            <input
                              type="time"
                              name="tue"
                              class="form-input form-input-sm"
                              value="{{ p.cutoff_tue_local.strftime('%H:%M') if p.cutoff_tue_local else '' }}"
                            >
                          </div>
                          <div class="cutoff-row">
                            <span class="cutoff-label">Wed</span>
                            <input
                              type="time"
                              name="wed"
                              class="form-input form-input-sm"
                              value="{{ p.cutoff_wed_local.strftime('%H:%M') if p.cutoff_wed_local else '' }}"
                            >
                          </div>
                          <div class="cutoff-row">
                            <span class="cutoff-label">Thu</span>
                            <input
                              type="time"
                              name="thu"
                              class="form-input form-input-sm"
                              value="{{ p.cutoff_thu_local.strftime('%H:%M') if p.cutoff_thu_local else '' }}"
                            >
                          </div>
                          <div class="cutoff-row">
                            <span class="cutoff-label">Fri</span>
                            <input
                              type="time"
                              name="fri"
                              class="form-input form-input-sm"
                              value="{{ p.cutoff_fri_local.strftime('%H:%M') if p.cutoff_fri_local else '' }}"
                            >
                          </div>
                          <div class="cutoff-row">
                            <span class="cutoff-label">Sat</span>
                            <input
                              type="time"
                              name="sat"
                              class="form-input form-input-sm"
                              value="{{ p.cutoff_sat_local.strftime('%H:%M') if p.cutoff_sat_local else '' }}"
                            >
                          </div>
                          <div class="cutoff-row">
                            <span class="cutoff-label">Sun</span>
                            <input
                              type="time"
                              name="sun"
                              class="form-input form-input-sm"
                              value="{{ p.cutoff_sun_local.strftime('%H:%M') if p.cutoff_sun_local else '' }}"
                            >
                          </div>
                        </div>

                        <hr class="cutoff-divider">

                        <div class="cutoff-row cutoff-weekdays-row">
                          <span class="cutoff-label">Mon–Fri</span>
                          <input
                            type="time"
                            name="weekdays_time"
                            class="form-input form-input-sm"
                          >
                          <button type="button" class="btn-xs btn-ghost js-apply-weekdays">
                            Apply to Mon–Fri
                          </button>
                        </div>

                        <p class="muted cutoff-hint">
                          After applying Mon–Fri time, please review all days before saving.
                        </p>

                        <div class="cutoffs-actions">
                          <button type="submit" class="btn btn-secondary btn-sm-inline">
                            Save
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </td>

              <td>
                <div class="assigned-users-block">
                  <div class="assigned-chips">
                    {% for uid in assignments.get(p.id, []) %}
                      {% set usr = user_by_id.get(uid) %}
                      {% if usr %}
                      <form
                        action="/admin/pharmacies/{{ p.id }}/unassign"
                        method="post"
                        class="assigned-chip js-ajax-form"
                        data-admin-action="pharmacy-unassign-user"
                      >
                        <input type="hidden" name="user_id" value="{{ usr.id }}">
                        <span class="assigned-name">{{ usr.login }}</span>
                        <button type="submit" class="assigned-remove">×</button>
                      </form>
                      {% endif %}
                    {% endfor %}
                  </div>

                  <!-- assign: only admins and drivers are shown in dropdown; history role is excluded -->
                  {% set assignable_users = users | selectattr('role', 'ne', 'history') | list %}
                  {% set default_user = assignable_users[0] if assignable_users else None %}

                  <form
                    action="/admin/pharmacies/{{ p.id }}/assign"
                    method="post"
                    class="assign-inline-form js-ajax-form"
                    data-admin-action="pharmacy-assign-user"
                  >
                    <div class="chip-dropdown-wrapper assign-user-wrapper">
                      <button type="button" class="chip chip-dropdown">
                        <span class="chip-main-text">
                          {% if default_user %}{{ default_user.login }}{% else %}No users{% endif %}
                        </span>
                        <span class="chip-caret"></span>
                      </button>

                      <div class="dropdown-menu">
                        {% for u in assignable_users %}
                        <button type="button" class="dropdown-item {% if loop.first %}is-active{% endif %}"
                                data-value="{{ u.id }}">
                          {{ u.login }}
                        </button>
                        {% endfor %}
                      </div>

                      <input type="hidden" name="user_id"
                             value="{{ default_user.id if default_user else '' }}">
                    </div>

                    <button type="submit" class="btn btn-primary btn-sm-inline">Assign</button>
                  </form>
                </div>
              </td>

              <td>
                <div class="form-actions form-actions-column">

                  <!-- toggle active -->
                  <form
                    action="/admin/pharmacies/{{ p.id }}/toggle"
                    method="post"
                    class="js-ajax-form"
                    data-admin-action="pharmacy-toggle-active"
                  >
                    <button type="submit" class="btn btn-secondary btn-toggle">
                      {{ 'Deactivate' if p.is_active else 'Activate' }}
                    </button>
                  </form>

                  <hr class="newdevider" />

                  <!-- delete -->
                  <form
                    action="/admin/pharmacies/{{ p.id }}/delete"
                    method="post"
                    class="js-ajax-form"
                    data-admin-action="pharmacy-delete"
                    onsubmit="return confirm('Delete pharmacy {{ p.name }}? This cannot be undone.');"
                  >
                    <button type="submit" class="btn btn-primary btn-danger">Delete</button>
                  </form>

                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    </div>
  </details>

</section>
{% endblock %}
