{% extends "base.html" %}
{% block title %}Admin ¬∑ PickUp Livery{% endblock %}

{% block content %}
<section class="page-hero">
  <h1 class="page-title">Admin panel</h1>
  <p class="lead">
    Quick stats, user/region/pharmacy management ‚Äî with per-user GPS settings and global config.
  </p>
  <div class="g-actions">
    <a href="/admin/settings" class="btn btn-secondary">Global settings</a>
  </div>
</section>

<section class="admin-glass">

  <!--======= STATISTICS =======-->
  <details class="g-section" data-section-id="admin-stats" open>
    <summary><h2>üìä Statistics</h2></summary>
    <ul class="g-badges">
      <li class="badge">Users: {{ stats.counts.users or 0 }}</li>
      <li class="badge">Regions: {{ stats.counts.regions or 0 }}</li>
      <li class="badge">Pharmacies: {{ stats.counts.pharmacies or 0 }}</li>
      <li class="badge">Pickups: {{ stats.counts.pickups or 0 }}</li>
      <li class="badge">Links: {{ stats.counts.user_pharmacy_links or 0 }}</li>
      <li class="badge">Photos: {{ stats.counts.pickup_photos or 0 }}</li>
      <li class="badge">App settings rows: {{ stats.counts.app_settings or 0 }}</li>
    </ul>
  </details>

  <!--======= USERS =======-->
  <details class="g-section" data-section-id="admin-users">
    <summary><h2>üë§ Users</h2></summary>

    <!-- Create user (full reload is OK here) -->
    <div class="g-card">
      <h3 class="g-subtitle">Create user</h3>
      <form action="/admin/users/create" method="post" class="form-grid">
        <label class="form-label">Login
          <input type="text" name="login" required class="form-input">
        </label>
        <label class="form-label">Password
          <input type="password" name="password" required minlength="6" class="form-input">
        </label>
        <label class="form-label">Role
          <select name="role" class="form-input">
            <option value="driver" selected>driver</option>
            <option value="admin">admin</option>
          </select>
        </label>

        <label class="form-label">
          Require GPS location
          <input type="checkbox" name="require_pickup_location" value="1">
          <small class="muted">
            If checked, this user must always send location
            (overrides global GPS setting).
          </small>
        </label>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>

    <!-- User list -->
    <div class="g-card">
      <h3 class="g-subtitle">Existing users</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Login</th>
              <th>Role</th>
              <th>Active</th>
              <th>Require GPS</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for u in users %}
            <tr>
              <td>{{ u.id }}</td>
              <td>{{ u.login }}</td>
              <td>{{ u.role }}</td>
              <td>{{ 'yes' if u.is_active else 'no' }}</td>
              <td>
                <div style="display:flex;flex-direction:column;gap:.25rem;">
                  <div>
                    {% if u.require_pickup_location is none %}
                      <span class="badge">inherit</span>
                    {% elif u.require_pickup_location %}
                      <span class="badge ok">yes</span>
                    {% else %}
                      <span class="badge warn">no</span>
                    {% endif %}
                  </div>
                  <!-- Per-user GPS mode (AJAX) -->
                  <form
                    action="/admin/users/{{ u.id }}/gps"
                    method="post"
                    class="form-grid js-ajax-form"
                    style="grid-template-columns:1fr auto;gap:.35rem;"
                  >
                    <select name="gps_mode" class="form-input" required>
                      <option value="inherit"
                        {% if u.require_pickup_location is none %}selected{% endif %}>
                        Inherit global
                      </option>
                      <option value="require"
                        {% if u.require_pickup_location is true %}selected{% endif %}>
                        Require GPS
                      </option>
                      <option value="no"
                        {% if u.require_pickup_location is false %}selected{% endif %}>
                        GPS not required
                      </option>
                    </select>
                    <button type="submit" class="btn btn-secondary">Update</button>
                  </form>
                </div>
              </td>
              <td>
                <div class="form-actions" style="flex-direction:column;gap:.35rem;">

                  <!-- Toggle active (AJAX) -->
                  <form action="/admin/users/{{ u.id }}/toggle" method="post" class="js-ajax-form">
                    <button type="submit" class="btn btn-secondary">
                      {{ 'Deactivate' if u.is_active else 'Activate' }}
                    </button>
                  </form>

                  <!-- Change password (AJAX) -->
                  <form
                    action="/admin/users/{{ u.id }}/password"
                    method="post"
                    class="form-grid js-ajax-form"
                    style="grid-template-columns:1fr auto;gap:.35rem;"
                  >
                    <input
                      type="password"
                      name="new_password"
                      placeholder="new password"
                      minlength="6"
                      required
                      class="form-input"
                    >
                    <button type="submit" class="btn btn-primary">Set</button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </details>

  <!--======= REGIONS =======-->
  <details class="g-section" data-section-id="admin-regions">
    <summary><h2>üó∫Ô∏è Regions</h2></summary>
    <div class="g-card">
      <h3 class="g-subtitle">Create region</h3>
      <!-- Create region (full reload is OK) -->
      <form action="/admin/regions/create" method="post" class="form-grid">
        <label class="form-label">Name
          <input type="text" name="name" required class="form-input">
        </label>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>

    <div class="g-card">
      <h3 class="g-subtitle">All regions</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>ID</th><th>Name</th><th>Active</th><th>Actions</th></tr>
          </thead>
          <tbody>
            {% for r in regions %}
            <tr>
              <td>{{ r.id }}</td>
              <td>{{ r.name }}</td>
              <td>{{ 'yes' if r.is_active else 'no' }}</td>
              <td>
                <!-- Toggle region (AJAX) -->
                <form
                  action="/admin/regions/{{ r.id }}/toggle"
                  method="post"
                  class="form-actions js-ajax-form"
                >
                  <button type="submit" class="btn btn-secondary">
                    {{ 'Deactivate' if r.is_active else 'Activate' }}
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </details>

  <!--======= PHARMACIES =======-->
  <details class="g-section" data-section-id="admin-pharmacies">
    <summary><h2>üè• Pharmacies</h2></summary>

    <div class="g-card">
      <h3 class="g-subtitle">Create pharmacy</h3>
      <!-- Create pharmacy (full reload is OK) -->
      <form action="/admin/pharmacies/create" method="post" class="form-grid">
        <label class="form-label">Name
          <input type="text" name="name" required class="form-input">
        </label>
        <label class="form-label">Region
          <select name="region_id" required class="form-input">
            {% for r in regions %}
              <option value="{{ r.id }}">{{ r.name }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="form-label">Address
          <input type="text" name="address" placeholder="optional" class="form-input">
        </label>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>

    <div class="g-card">
      <h3 class="g-subtitle">All pharmacies</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Region</th>
              <th>Active</th>
              <th>Assigned users</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for p in pharmacies %}
            <tr>
              <td>{{ p.id }}</td>
              <td>{{ p.name }}</td>
              <td>{{ region_by_id.get(p.region_id).name if region_by_id.get(p.region_id) else '-' }}</td>
              <td>{{ 'yes' if p.is_active else 'no' }}</td>
              <td>
                <ul class="g-ul">
                  {% for uid in assignments.get(p.id, []) %}
                    {% set usr = user_by_id.get(uid) %}
                    {% if usr %}
                      <li class="g-li">
                        <span>{{ usr.login }}</span>
                        <!-- Unassign user (AJAX) -->
                        <form
                          action="/admin/pharmacies/{{ p.id }}/unassign"
                          method="post"
                          class="js-ajax-form"
                        >
                          <input type="hidden" name="user_id" value="{{ usr.id }}">
                          <button type="submit" class="btn btn-secondary" title="Unassign">√ó</button>
                        </form>
                      </li>
                    {% endif %}
                  {% endfor %}
                </ul>

                <!-- Assign user (AJAX) -->
                <form
                  action="/admin/pharmacies/{{ p.id }}/assign"
                  method="post"
                  class="form-grid g-assign js-ajax-form"
                >
                  <select name="user_id" required class="form-input">
                    {% for u in users %}
                      <option value="{{ u.id }}">{{ u.login }}</option>
                    {% endfor %}
                  </select>
                  <button type="submit" class="btn btn-primary">Assign</button>
                </form>
              </td>
              <td>
                <!-- Toggle pharmacy (AJAX) -->
                <form
                  action="/admin/pharmacies/{{ p.id }}/toggle"
                  method="post"
                  class="form-actions js-ajax-form"
                >
                  <button type="submit" class="btn btn-secondary">
                    {{ 'Deactivate' if p.is_active else 'Activate' }}
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </details>

</section>
{% endblock %}
