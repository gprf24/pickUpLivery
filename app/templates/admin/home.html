{% extends "base.html" %}
{% block title %}Admin ¬∑ PickUp Livery{% endblock %}

{% block content %}
<section class="page-hero">
  <h1 class="page-title">Admin panel</h1>
  <p class="lead">
    Quick stats, user/region/pharmacy management ‚Äî with per-user GPS settings and global config.
  </p>
  <div class="g-actions">
    <a href="/admin/settings" class="btn btn-secondary">Global settings</a>
  </div>
</section>

<section class="admin-glass">

  <!--======= STATISTICS =======-->
  <details class="g-section" data-section-id="admin-stats" open>
    <summary>
      <h2>üìä Statistics</h2>
    </summary>
    <ul class="g-badges">
      <li class="badge">Users: {{ stats.counts.users or 0 }}</li>
      <li class="badge">Regions: {{ stats.counts.regions or 0 }}</li>
      <li class="badge">Pharmacies: {{ stats.counts.pharmacies or 0 }}</li>
      <li class="badge">Pickups: {{ stats.counts.pickups or 0 }}</li>
      <li class="badge">Links: {{ stats.counts.user_pharmacy_links or 0 }}</li>
      <li class="badge">Photos: {{ stats.counts.pickup_photos or 0 }}</li>
      <li class="badge">App settings rows: {{ stats.counts.app_settings or 0 }}</li>
    </ul>
  </details>

  <!--======= USERS =======-->
  <details class="g-section" data-section-id="admin-users">
    <summary>
      <h2>üë§ Users ({{ stats.counts.users or 0 }})</h2>
    </summary>

    <!-- Create user -->
    <div class="g-card">
      <h3 class="g-subtitle">Create user</h3>

      <form action="/admin/users/create" method="post" class="form-grid">
        <label class="form-label">
          Login
          <input type="text" name="login" required class="form-input">
        </label>

        <label class="form-label">
          Password
          <input type="password" name="password" required minlength="6" class="form-input">
        </label>

        <label class="form-label">
          Role
          <div class="chip-dropdown-wrapper role-dropdown-wrapper">
            <button type="button" class="chip chip-dropdown">
              <span class="chip-main-text">Driver</span>
              <span class="chip-caret"></span>
            </button>

            <div class="dropdown-menu">
              <button type="button" class="dropdown-item is-active" data-value="driver">
                Driver
              </button>
              <button type="button" class="dropdown-item" data-value="admin">
                Admin
              </button>
            </div>

            <input type="hidden" name="role" value="driver">
          </div>
        </label>

        <label class="form-label checkbox-inline">
          <input type="checkbox" name="require_pickup_location" value="1" checked>
          <div class="checkbox-text">
            <span class="checkbox-title">Require GPS location</span>
            <small class="muted">
              If checked ‚Üí always require GPS. If unchecked ‚Üí inherit global setting.
            </small>
          </div>
        </label>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>

    <!-- User list -->
    <div class="g-card">
      <h3 class="g-subtitle">Existing users</h3>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Login</th>
              <th>Role</th>
              <th>Active</th>
              <th>Require GPS</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            {% for u in users %}
            <tr data-user-id="{{ u.id }}">
              <td>{{ u.id }}</td>
              <td>{{ u.login }}</td>

              <td>
                {% if u.role == 'admin' %}Admin{% elif u.role == 'driver' %}Driver{% else %}{{ u.role }}{% endif %}
              </td>

              <!-- Active pill -->
              <td>
                {% if u.is_active %}
                  <span class="status-pill status-ok">Yes</span>
                {% else %}
                  <span class="status-pill">No</span>
                {% endif %}
              </td>

              <!-- GPS MODE -->
              <td>
                <div class="user-gps-block">

                  {% set current_gps_mode =
                      'inherit' if u.require_pickup_location is none
                      else 'require' if u.require_pickup_location
                      else 'no'
                  %}

                  <form
                    action="/admin/users/{{ u.id }}/gps"
                    method="post"
                    class="gps-inline-form js-ajax-form"
                    data-admin-action="user-gps-update"
                  >
                    <div class="chip-dropdown-wrapper gps-mode-wrapper">
                      <button type="button" class="chip chip-dropdown chip-gps">
                        <span class="chip-main-text">
                          {% if current_gps_mode == 'inherit' %}
                            Inherit global
                          {% elif current_gps_mode == 'require' %}
                            Require GPS
                          {% else %}
                            GPS not required
                          {% endif %}
                        </span>
                        <span class="chip-caret"></span>
                      </button>

                      <div class="dropdown-menu">
                        <button type="button"
                                class="dropdown-item {% if current_gps_mode == 'inherit' %}is-active{% endif %}"
                                data-value="inherit">
                          Inherit global
                        </button>
                        <button type="button"
                                class="dropdown-item {% if current_gps_mode == 'require' %}is-active{% endif %}"
                                data-value="require">
                          Require GPS
                        </button>
                        <button type="button"
                                class="dropdown-item {% if current_gps_mode == 'no' %}is-active{% endif %}"
                                data-value="no">
                          GPS not required
                        </button>
                      </div>

                      <input type="hidden" name="gps_mode" value="{{ current_gps_mode }}">
                    </div>

                    <button type="submit" class="btn btn-secondary btn-sm-inline">Update</button>
                  </form>
                </div>
              </td>

              <!-- ACTIONS -->
              <td>
                <div class="form-actions form-actions-row">

                  <!-- Change password -->
                  <form
                    action="/admin/users/{{ u.id }}/password"
                    method="post"
                    class="form-grid js-ajax-form"
                    data-admin-action="user-password-change"
                  >
                    <input type="password" name="new_password" placeholder="new password" minlength="6" required class="form-input">
                    <button type="submit" class="btn btn-primary">Set</button>
                  </form>

                  <!-- Toggle active -->
                  <form
                    action="/admin/users/{{ u.id }}/toggle-active"
                    method="post"
                    class="js-ajax-form"
                    data-admin-action="user-toggle-active"
                  >
                    <button type="submit" class="btn btn-secondary">
                      {{ 'Deactivate' if u.is_active else 'Activate' }}
                    </button>
                  </form>

                  <hr class="newdevider" />

                  <!-- Delete user -->
                  <form
                    action="/admin/users/{{ u.id }}/delete"
                    method="post"
                    class="js-ajax-form"
                    data-admin-action="user-delete"
                    onsubmit="return confirm('Delete user {{ u.login }}? This cannot be undone.');"
                  >
                    <button type="submit" class="btn btn-primary btn-danger">Delete</button>
                  </form>

                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    </div>
  </details>

  <!--======== REGIONS ========-->
  <details class="g-section" data-section-id="admin-regions">
    <summary>
      <h2>üó∫Ô∏è Regions ({{ stats.counts.regions or 0 }})</h2>
    </summary>

    <div class="g-card">
      <h3 class="g-subtitle">Create region</h3>

      <form action="/admin/regions/create" method="post" class="form-grid">
        <label class="form-label">
          Name
          <input type="text" name="name" required class="form-input">
        </label>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>

    <div class="g-card">
      <h3 class="g-subtitle">All regions</h3>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Active</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            {% for r in regions %}
            <tr data-region-id="{{ r.id }}">
              <td>{{ r.id }}</td>
              <td>{{ r.name }}</td>

              <td>
                {% if r.is_active %}
                  <span class="status-pill status-ok">Yes</span>
                {% else %}
                  <span class="status-pill">No</span>
                {% endif %}
              </td>

              <td>
                <div class="form-actions form-actions-row">

                  <!-- toggle -->
                  <form
                    action="/admin/regions/{{ r.id }}/toggle"
                    method="post"
                    class="js-ajax-form"
                    data-admin-action="region-toggle-active"
                  >
                    <button type="submit" class="btn btn-secondary">
                      {{ 'Deactivate' if r.is_active else 'Activate' }}
                    </button>
                  </form>

                  <hr class="newdevider" />

                  <!-- delete -->
                  <form
                    action="/admin/regions/{{ r.id }}/delete"
                    method="post"
                    class="js-ajax-form"
                    data-admin-action="region-delete"
                    onsubmit="return confirm('Delete region {{ r.name }}? This cannot be undone.');"
                  >
                    <button type="submit" class="btn btn-primary btn-danger">Delete</button>
                  </form>

                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    </div>
  </details>

  <!--======== PHARMACIES ========-->
  <details class="g-section" data-section-id="admin-pharmacies">
    <summary>
      <h2>üè• Pharmacies ({{ stats.counts.pharmacies or 0 }})</h2>
    </summary>

    <div class="g-card">
      <h3 class="g-subtitle">Create pharmacy</h3>

      {% set default_region_id = regions[0].id if regions else '' %}
      {% set default_region_name = regions[0].name if regions else 'No regions' %}

      <form action="/admin/pharmacies/create" method="post" class="form-grid">

        <label class="form-label">
          Name
          <input type="text" name="name" required class="form-input">
        </label>

        <label class="form-label">
          Region
          <div class="chip-dropdown-wrapper region-dropdown-wrapper">
            <button type="button" class="chip chip-dropdown">
              <span class="chip-main-text">{{ default_region_name }}</span>
              <span class="chip-caret"></span>
            </button>

            <div class="dropdown-menu" style="max-width: 220px;">
              {% for r in regions %}
              <button type="button" class="dropdown-item {% if loop.first %}is-active{% endif %}"
                      data-value="{{ r.id }}">
                {{ r.name }}
              </button>
              {% endfor %}
            </div>

            <input type="hidden" name="region_id" value="{{ default_region_id }}">
          </div>
        </label>

        <label class="form-label">
          Address
          <input type="text" name="address" class="form-input" placeholder="optional">
        </label>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>

    <div class="g-card">
      <h3 class="g-subtitle">All pharmacies</h3>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Region</th>
              <th>Active</th>
              <th>Assigned users</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            {% for p in pharmacies %}
            <tr data-pharmacy-id="{{ p.id }}">
              <td>{{ p.id }}</td>
              <td>{{ p.name }}</td>
              <td>
                {{ region_by_id.get(p.region_id).name if region_by_id.get(p.region_id) else '-' }}
              </td>

              <td>
                {% if p.is_active %}
                  <span class="status-pill status-ok">Yes</span>
                {% else %}
                  <span class="status-pill">No</span>
                {% endif %}
              </td>

              <td>
                <div class="assigned-users-block">
                  <div class="assigned-chips">
                    {% for uid in assignments.get(p.id, []) %}
                      {% set usr = user_by_id.get(uid) %}
                      {% if usr %}
                      <form
                        action="/admin/pharmacies/{{ p.id }}/unassign"
                        method="post"
                        class="assigned-chip js-ajax-form"
                        data-admin-action="pharmacy-unassign-user"
                      >
                        <input type="hidden" name="user_id" value="{{ usr.id }}">
                        <span class="assigned-name">{{ usr.login }}</span>
                        <button type="submit" class="assigned-remove">√ó</button>
                      </form>
                      {% endif %}
                    {% endfor %}
                  </div>

                  <!-- assign -->
                  {% set default_user = users[0] if users else None %}
                  <form
                    action="/admin/pharmacies/{{ p.id }}/assign"
                    method="post"
                    class="assign-inline-form js-ajax-form"
                    data-admin-action="pharmacy-assign-user"
                  >
                    <div class="chip-dropdown-wrapper assign-user-wrapper">
                      <button type="button" class="chip chip-dropdown">
                        <span class="chip-main-text">
                          {% if default_user %}{{ default_user.login }}{% else %}No users{% endif %}
                        </span>
                        <span class="chip-caret"></span>
                      </button>

                      <div class="dropdown-menu">
                        {% for u in users %}
                        <button type="button" class="dropdown-item {% if loop.first %}is-active{% endif %}"
                                data-value="{{ u.id }}">
                          {{ u.login }}
                        </button>
                        {% endfor %}
                      </div>

                      <input type="hidden" name="user_id"
                             value="{{ default_user.id if default_user else '' }}">
                    </div>

                    <button type="submit" class="btn btn-primary btn-sm-inline">Assign</button>
                  </form>
                </div>
              </td>

              <td>
                <div class="form-actions form-actions-column">

                  <!-- toggle active -->
                  <form
                    action="/admin/pharmacies/{{ p.id }}/toggle"
                    method="post"
                    class="js-ajax-form"
                    data-admin-action="pharmacy-toggle-active"
                  >
                    <button type="submit" class="btn btn-secondary">
                      {{ 'Deactivate' if p.is_active else 'Activate' }}
                    </button>
                  </form>

                  <hr class="newdevider" />

                  <!-- delete -->
                  <form
                    action="/admin/pharmacies/{{ p.id }}/delete"
                    method="post"
                    class="js-ajax-form"
                    data-admin-action="pharmacy-delete"
                    onsubmit="return confirm('Delete pharmacy {{ p.name }}? This cannot be undone.');"
                  >
                    <button type="submit" class="btn btn-primary btn-danger">Delete</button>
                  </form>

                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    </div>
  </details>

</section>

<!-- Inline JS: chip dropdown -->
<script>
  document.addEventListener("click", function (event) {
    const chip = event.target.closest(".chip-dropdown");
    if (chip) {
      const w = chip.closest(".chip-dropdown-wrapper");
      w.classList.toggle("is-open");
      return;
    }

    const item = event.target.closest(".chip-dropdown-wrapper .dropdown-item");
    if (item) {
      const w = item.closest(".chip-dropdown-wrapper");
      const hidden = w.querySelector("input[type='hidden']");
      const label = w.querySelector(".chip-main-text");

      hidden.value = item.dataset.value;
      label.textContent = item.textContent.trim();

      w.querySelectorAll(".dropdown-item").forEach(b => {
        b.classList.toggle("is-active", b === item);
      });

      w.classList.remove("is-open");
      return;
    }

    if (!event.target.closest(".chip-dropdown-wrapper")) {
      document
        .querySelectorAll(".chip-dropdown-wrapper.is-open")
        .forEach(w => w.classList.remove("is-open"));
    }
  });
</script>

{% endblock %}
