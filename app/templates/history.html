{% extends "base.html" %}
{% block title %}History · PickUp Livery{% endblock %}

{% block content %}

<section class="page-hero">
  <h1 class="page-title">Pickup History</h1>
  <p class="lead">Filter by date, region, pharmacy or driver. The list updates automatically.</p>
</section>

{% if user.role == "admin" or user.role == "history" %}
  <!-- ===================== FILTER + EXPORT ROW ===================== -->
  <section class="filter-export-row">

    <!-- ===================== FILTER BAR ===================== -->
    <section class="card filter-bar">
      <form method="get" action="/history" class="filter-chips-layout" id="historyFilters">

        <!-- Hidden quick_range for presets -->
        <input type="hidden" name="quick_range" id="quickRangeInput"
               value="{{ active_filters.quick_range or '' }}">

        <!-- Left: simple counter -->
        <div class="filter-counter">
          Days:
          <span class="filter-counter-number">
            {{ groups|length or 0 }}
          </span>
        </div>

        <!-- ========= DATE CHIP + POPOVER ========= -->
        <div class="chip-wrapper">
          {% set df = active_filters.date_from %}
          {% set dt = active_filters.date_to %}

          <!-- Chip that shows the currently selected range -->
          <button type="button" class="chip chip-date" id="dateChip">
            <span class="chip-main-text">
              {% if df or dt %}
                {{ df or '...' }} – {{ dt or '...' }}
              {% else %}
                Select period
              {% endif %}
            </span>
            {% if df or dt %}
              <span class="chip-clear-icon" id="clearDatesIcon">×</span>
            {% endif %}
            <span class="chip-caret"></span>
          </button>

          <!-- Popover with presets + calendar -->
          <div class="date-popover" id="datePopover">
            <div class="date-popover-panel">
              <div class="date-popover-grid">

                <!-- Presets column -->
                <div class="date-presets">
                  <button type="button"
                          class="quick-btn {% if active_filters.quick_range=='today' %}is-active{% endif %}"
                          data-range="today">Today</button>

                  <button type="button"
                          class="quick-btn {% if active_filters.quick_range=='yesterday' %}is-active{% endif %}"
                          data-range="yesterday">Yesterday</button>

                  <button type="button"
                          class="quick-btn {% if active_filters.quick_range=='this_week' %}is-active{% endif %}"
                          data-range="this_week">This week</button>

                  <button type="button"
                          class="quick-btn {% if active_filters.quick_range=='last_week' %}is-active{% endif %}"
                          data-range="last_week">Last week</button>
                </div>

                <!-- Date inputs -->
                <div class="date-inputs">
                  <label class="date-input-label">
                    From
                    <input type="date"
                           name="date_from"
                           value="{{ active_filters.date_from }}"
                           class="date-input js-filter-auto">
                  </label>

                  <label class="date-input-label">
                    To
                    <input type="date"
                           name="date_to"
                           value="{{ active_filters.date_to }}"
                           class="date-input js-filter-auto">
                  </label>

                  <button type="button" class="btn-xs btn-ghost" id="clearDatesBtn">
                    Reset
                  </button>
                </div>

              </div>
            </div>
          </div>
        </div>

        {# ========= REGION DROPDOWN CHIP ========= #}
        {% set ns_region = namespace(label='') %}
        {% if active_filters.region_id %}
          {% for r in regions %}
            {% if r.id == active_filters.region_id|int %}
              {% set ns_region.label = r.name %}
            {% endif %}
          {% endfor %}
        {% endif %}
        <div class="chip-dropdown-wrapper" data-filter="region">
          <button type="button" class="chip chip-dropdown">
            <span class="chip-main-text">
              {{ ns_region.label or 'Region' }}
            </span>
            {% if ns_region.label %}
              <span class="chip-clear-icon">×</span>
            {% endif %}
            <span class="chip-caret"></span>
          </button>
          <div class="dropdown-menu">
            <button type="button"
                    class="dropdown-item {% if not active_filters.region_id %}is-active{% endif %}"
                    data-value="">
              All regions
            </button>
            {% for r in regions %}
              <button type="button"
                      class="dropdown-item {% if active_filters.region_id and r.id == active_filters.region_id|int %}is-active{% endif %}"
                      data-value="{{ r.id }}">
                {{ r.name }}
              </button>
            {% endfor %}
          </div>
          <input type="hidden" name="region_id" value="{{ active_filters.region_id }}">
        </div>

        {# ========= PHARMACY DROPDOWN CHIP ========= #}
        {% set ns_pharmacy = namespace(label='') %}
        {% if active_filters.pharmacy_id %}
          {% for p in pharmacies %}
            {% if p.id == active_filters.pharmacy_id|int %}
              {% set ns_pharmacy.label = p.name %}
            {% endif %}
          {% endfor %}
        {% endif %}
        <div class="chip-dropdown-wrapper" data-filter="pharmacy">
          <button type="button" class="chip chip-dropdown">
            <span class="chip-main-text">
              {{ ns_pharmacy.label or 'Pharmacy' }}
            </span>
            {% if ns_pharmacy.label %}
              <span class="chip-clear-icon">×</span>
            {% endif %}
            <span class="chip-caret"></span>
          </button>
          <div class="dropdown-menu">
            <button type="button"
                    class="dropdown-item {% if not active_filters.pharmacy_id %}is-active{% endif %}"
                    data-value="">
              All pharmacies
            </button>
            {% for p in pharmacies %}
              <button type="button"
                      class="dropdown-item {% if active_filters.pharmacy_id and p.id == active_filters.pharmacy_id|int %}is-active{% endif %}"
                      data-value="{{ p.id }}">
                {{ p.name }}
              </button>
            {% endfor %}
          </div>
          <input type="hidden" name="pharmacy_id" value="{{ active_filters.pharmacy_id }}">
        </div>

        {# ========= DRIVER DROPDOWN CHIP ========= #}
        {% set ns_driver = namespace(label='') %}
        {% if active_filters.driver_id %}
          {% for u in users %}
            {% if u.id == active_filters.driver_id|int %}
              {% set ns_driver.label = u.full_name or u.login %}
            {% endif %}
          {% endfor %}
        {% endif %}
        <div class="chip-dropdown-wrapper" data-filter="driver">
          <button type="button" class="chip chip-dropdown">
            <span class="chip-main-text">
              {{ ns_driver.label or 'Driver' }}
            </span>
            {% if ns_driver.label %}
              <span class="chip-clear-icon">×</span>
            {% endif %}
            <span class="chip-caret"></span>
          </button>
          <div class="dropdown-menu">
            <button type="button"
                    class="dropdown-item {% if not active_filters.driver_id %}is-active{% endif %}"
                    data-value="">
              All drivers
            </button>
            {% for u in users %}
              <button type="button"
                      class="dropdown-item {% if active_filters.driver_id and u.id == active_filters.driver_id|int %}is-active{% endif %}"
                      data-value="{{ u.id }}">
                {{ u.full_name or u.login }}
              </button>
            {% endfor %}
          </div>
          <input type="hidden" name="driver_id" value="{{ active_filters.driver_id }}">
        </div>

        <!-- ========= CLEAR ALL ========= -->
        <div class="filter-actions">
          <a href="/history" role="button" class="btn btn-secondary">Reset</a>
        </div>
      </form>
    </section>

    <!-- ===================== EXPORT CARD ===================== -->
    <section class="card export-card">
      <form method="get" action="/history/export" class="export-form">
        {# Pass current filters so export matches visible list #}
        <input type="hidden" name="region_id" value="{{ active_filters.region_id }}">
        <input type="hidden" name="pharmacy_id" value="{{ active_filters.pharmacy_id }}">
        <input type="hidden" name="driver_id" value="{{ active_filters.driver_id }}">
        <input type="hidden" name="date_from" value="{{ active_filters.date_from }}">
        <input type="hidden" name="date_to" value="{{ active_filters.date_to }}">
        <input type="hidden" name="quick_range" value="{{ active_filters.quick_range }}">

        {% set current_format = request.query_params.get('format', 'csv') %}

        <div class="export-label">
          <div class="export-title">Export</div>
          <div class="export-sub">Current filtered list</div>
        </div>

        <!-- Chip-style dropdown for export format -->
        <div class="chip-dropdown-wrapper export-format-wrapper">
          <button type="button" class="chip chip-dropdown chip-export" id="exportFormatChip">
            <span class="chip-main-text">
              {% if current_format == 'xlsx' %}
                Excel (.xlsx)
              {% else %}
                CSV
              {% endif %}
            </span>
            <span class="chip-caret"></span>
          </button>

          <div class="dropdown-menu">
            <button type="button"
                    class="dropdown-item {% if current_format != 'xlsx' %}is-active{% endif %}"
                    data-value="csv">
              CSV
            </button>
            <button type="button"
                    class="dropdown-item {% if current_format == 'xlsx' %}is-active{% endif %}"
                    data-value="xlsx">
              Excel (.xlsx)
            </button>
          </div>

          <input type="hidden" name="format" value="{{ current_format }}">
        </div>

        <div class="export-actions">
          <button type="submit" class="btn btn-secondary btn-export">
            Download
          </button>
        </div>
      </form>
    </section>

  </section>
{% endif %}

<!-- Warn messages -->
{% if warnings and warnings|length %}
  <div class="alert alert-warn">
    <ul style="margin:0; padding-left:1.2rem;">
      {% for w in warnings %}
        <li>{{ w }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

<!-- ======================== HISTORY LIST ======================== -->

{% if groups and groups|length %}
  <section class="card history-card">
    <div class="h-legend muted">Click a row to see photos, GPS, comment & metadata.</div>

    {# groups: dict[day_str] -> list of (pickup, pharmacy, region, user) #}
    {% for day, items in groups.items() %}
      {% set count = items|length %}

      <div class="history-day">
        <div class="history-day-header">
          <div class="history-day-main">
            <h3 class="history-day-title">{{ day }}</h3>
            <span class="pill">
              {{ count }}
              {% if count == 1 %}item{% else %}items{% endif %}
            </span>
          </div>
        </div>

        <div class="history-list">
          {% for pickup, ph, r, u in items %}
            {% set pids = (photo_public_ids.get(pickup.id) or []) %}
            {% set photo_qty = pids|length %}
            {% set timing = pickup.timing_status or 'no_cutoff' %}

            <details class="history-row">
              <summary>
                <div class="history-row-main">

                  <!-- Time (shown in local time with weekday via JS) -->
                  <span class="history-col time">
                    <time class="utc-to-local"
                          datetime="{{ pickup.created_at.strftime('%Y-%m-%dT%H:%M:%S') }}Z"
                          title="UTC: {{ pickup.created_at.strftime('%Y-%m-%d %H:%M:%S') }}Z">
                      {{ pickup.created_at.strftime('%Y-%m-%d %H:%M') }} UTC
                    </time>
                  </span>

                  <!-- Driver (admin + history roles) -->
                  {% if user.role == "admin" or user.role == "history" %}
                    <span class="history-col driver">
                      {% if u %}
                        {{ u.full_name or u.login }}
                      {% else %}
                        -
                      {% endif %}
                    </span>
                  {% endif %}

                  <!-- Region -->
                  <span class="history-col region">
                    {% if r %}
                      {{ r.name }}
                    {% else %}
                      -
                    {% endif %}
                  </span>

                  <!-- Pharmacy -->
                  <span class="history-col pharmacy">
                    {% if ph %}
                      {{ ph.name }}
                    {% else %}
                      -
                    {% endif %}
                  </span>

                  <!-- Photos -->
                  <span class="history-col photos">
                    {% if photo_qty > 0 %}
                      {{ photo_qty }} {% if photo_qty == 1 %}photo{% else %}photos{% endif %}
                    {% else %}
                      —
                    {% endif %}
                  </span>

                  <!-- Timing status (on_time / late / no_cutoff) -->
                  <span class="history-col status">
                    {% if timing == "late" %}
                      <span class="status-pill status-late"
                            title="Pickup was created after the latest allowed time (late).">
                        Late
                      </span>
                    {% elif timing == "on_time" %}
                      <span class="status-pill status-ok"
                            title="Pickup was created before or at the latest allowed time (on time).">
                        On time
                      </span>
                    {% else %}
                      <span class="status-pill"
                            title="No cutoff time was defined for this pharmacy at the moment of pickup.">
                        No cutoff
                      </span>
                    {% endif %}
                  </span>

                  <!-- Right arrow chevron -->
                  <span class="history-col arrow" aria-hidden="true">›</span>
                </div>
              </summary>

              <!-- ============ DETAILS PANEL ============ -->
              <div class="history-row-details">
                <div class="history-detail-grid">

                  <!-- Photos -->
                  <div class="history-detail-block">
                    <h4>Photos</h4>
                    {% if photo_qty > 0 %}
                      <div class="photo-grid">
                        {# Thumbnails – clicking opens lightbox #}
                        {% for pid in pids[:6] %}
                          <button type="button"
                                  class="photo-thumb"
                                  data-pids="{{ pids|join(',') }}"
                                  data-index="{{ loop.index0 }}">
                            <img src="/pickup/photos/{{ pid }}" alt="pickup photo" loading="lazy">
                          </button>
                        {% endfor %}
                      </div>
                    {% else %}
                      <p class="muted">No photos uploaded.</p>
                    {% endif %}
                  </div>

                  <!-- GPS / Map -->
                  <div class="history-detail-block">
                    <h4>Location</h4>

                    {% if pickup.latitude and pickup.longitude %}
                      <!-- Text coordinates -->
                      <div class="location-coords">
                        {{ "%.5f"|format(pickup.latitude) }},
                        {{ "%.5f"|format(pickup.longitude) }}
                      </div>

                      <!-- Interactive Leaflet map; initialized via JS using data-* -->
                      <div class="location-map"
                           data-lat="{{ pickup.latitude }}"
                           data-lng="{{ pickup.longitude }}">
                      </div>

                      <!-- Link to open in full Google Maps -->
                      <p class="location-link">
                        <a href="https://www.google.com/maps/search/?api=1&query={{ pickup.latitude }},{{ pickup.longitude }}"
                           target="_blank" class="link">
                          Open in Google Maps
                        </a>
                      </p>
                    {% else %}
                      <p class="muted">No GPS coordinates.</p>
                    {% endif %}
                  </div>

                  <!-- Metadata -->
                  <div class="history-detail-block">
                    <h4>Metadata</h4>
                    <dl class="meta-list">
                      <div>
                        <dt>Status</dt>
                        <dd>{{ pickup.status }}</dd>
                      </div>
                      <div>
                        <dt>Timing status</dt>
                        <dd>
                          {% if pickup.timing_status == "late" %}
                            Late (after cutoff)
                          {% elif pickup.timing_status == "on_time" %}
                            On time (within cutoff)
                          {% elif pickup.timing_status == "no_cutoff" %}
                            No cutoff defined
                          {% else %}
                            <span class="muted">Unknown</span>
                          {% endif %}
                        </dd>
                      </div>
                      <div>
                        <dt>Cutoff snapshot</dt>
                        <dd>
                          {% if pickup.cutoff_at_utc %}
                            <time class="utc-to-local"
                                  datetime="{{ pickup.cutoff_at_utc.strftime('%Y-%m-%dT%H:%M:%S') }}Z"
                                  title="UTC: {{ pickup.cutoff_at_utc.strftime('%Y-%m-%d %H:%M:%S') }}Z">
                              {{ pickup.cutoff_at_utc.strftime('%Y-%m-%d %H:%M') }} UTC
                            </time>
                          {% else %}
                            <span class="muted">No cutoff was active for this day.</span>
                          {% endif %}
                        </dd>
                      </div>
                      <div>
                        <dt>Created at (UTC)</dt>
                        <dd>{{ pickup.created_at.strftime('%Y-%m-%d %H:%M') }}</dd>
                      </div>
                      <div>
                        <dt>Pickup ID</dt>
                        <dd>{{ pickup.id }}</dd>
                      </div>
                      <div>
                        <dt>Comment</dt>
                        <dd>
                          {% if pickup.comment %}
                            {{ pickup.comment }}
                          {% else %}
                            <span class="muted">No comment.</span>
                          {% endif %}
                        </dd>
                      </div>
                    </dl>
                  </div>

                </div>
              </div>

            </details>
          {% endfor %}
        </div>
      </div>

    {% endfor %}
  </section>

{% else %}
  <div class="alert alert-warn">No pickups found.</div>
{% endif %}

{# ===================== LIGHTBOX / CAROUSEL OVERLAY ===================== #}
<div class="lightbox-backdrop" id="photoLightbox" hidden>
  <div class="lightbox-content" role="dialog" aria-modal="true" aria-label="Pickup photos">
    <button type="button" class="lightbox-close" id="lightboxClose" aria-label="Close">×</button>
    <button type="button" class="lightbox-nav lightbox-prev" id="lightboxPrev" aria-label="Previous photo">‹</button>
    <img id="lightboxImage" alt="Pickup photo">
    <button type="button" class="lightbox-nav lightbox-next" id="lightboxNext" aria-label="Next photo">›</button>
    <div class="lightbox-counter" id="lightboxCounter"></div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{# ===================== LEAFLET ASSETS (CDNJS with correct SRI) ===================== #}
{# CSS for Leaflet maps #}
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
  integrity="sha512-Zcn6bjR/8RZbLEpLIeOwNtzREBAJnUKESxces60Mpoj+2okopSAcSUIUOseddDm0cxnGQzxIR7vJgsLZbdLE3w=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
/>

{# JS for Leaflet maps #}
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"
  integrity="sha512-BwHfrr4c9kmRkLw6iXFdzcdWV/PGkVgiIyIWLLlTSXzWQzxuSg4DiQUCpauz/EWjgk5TYQqX/kvn9pG1NpYfqg=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer">
</script>

<script>
/* ===================== UTC → Local conversion ===================== */
/* Converts all <time class="utc-to-local"> elements from UTC to local time
   and shows weekday + date + time. */
(function() {
  const nodes = document.querySelectorAll("time.utc-to-local");
  for (const t of nodes) {
    const iso = t.getAttribute("datetime");
    if (!iso) continue;
    const d = new Date(iso);
    if (isNaN(d.getTime())) continue;

    const opts = {
      weekday: "short",
      year: "numeric", month: "2-digit", day: "2-digit",
      hour: "2-digit", minute: "2-digit"
    };
    t.textContent = new Intl.DateTimeFormat("en-GB", opts).format(d);
    // Alternative: use browser default locale
    // t.textContent = new Intl.DateTimeFormat(undefined, opts).format(d);
  }
})();

/* ========================= FILTER LOGIC =========================== */
/* Handles:
   - date range popover + presets
   - auto-submit on change
   - chip dropdowns (region, pharmacy, driver)
   - clear buttons
*/
(function() {
  const form = document.getElementById("historyFilters");
  if (!form) return;

  const quickInput = document.getElementById("quickRangeInput");
  const dateFrom = form.querySelector('input[name="date_from"]');
  const dateTo   = form.querySelector('input[name="date_to"]');

  /* --- auto-submit on date change --- */
  const autos = form.querySelectorAll(".js-filter-auto");
  autos.forEach(el => {
    el.addEventListener("change", () => {
      form.submit();
    });
  });

  /* -------------------- date chip + popover -------------------- */
  const dateChip = document.getElementById("dateChip");
  const datePopover = document.getElementById("datePopover");
  const clearDatesIcon = document.getElementById("clearDatesIcon");
  const clearBtn = document.getElementById("clearDatesBtn");

  function closePopover() {
    if (!datePopover) return;
    datePopover.classList.remove("is-open");
  }

  if (dateChip && datePopover) {
    // Open/close on chip click (ignore click on inner "x")
    dateChip.addEventListener("click", (ev) => {
      if (ev.target && ev.target.closest(".chip-clear-icon")) return;
      datePopover.classList.toggle("is-open");
    });

    // Close on outside click
    document.addEventListener("click", (ev) => {
      if (!datePopover.classList.contains("is-open")) return;
      if (datePopover.contains(ev.target) || dateChip.contains(ev.target)) return;
      closePopover();
    });
  }

  /* --- clear via small "x" in date chip --- */
  if (clearDatesIcon) {
    clearDatesIcon.addEventListener("click", (ev) => {
      ev.stopPropagation();  // don't open popover
      if (dateFrom) dateFrom.value = "";
      if (dateTo) dateTo.value = "";
      if (quickInput) quickInput.value = "";
      form.submit();
    });
  }

  /* --- clear via Reset button in popover --- */
  if (clearBtn) {
    clearBtn.addEventListener("click", () => {
      if (dateFrom) dateFrom.value = "";
      if (dateTo) dateTo.value = "";
      if (quickInput) quickInput.value = "";
      form.submit();
    });
  }

  /* -------------------- quick-range presets -------------------- */
  const quickBtns = form.querySelectorAll(".quick-btn");
  quickBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      const range = btn.dataset.range || "";
      if (quickInput) quickInput.value = range;

      // Clear manual dates so backend uses quick_range
      if (dateFrom) dateFrom.value = "";
      if (dateTo) dateTo.value = "";

      form.submit();
    });
  });

  /* -------------------- custom dropdown chips -------------------- */
  const dropdownWrappers = form.querySelectorAll(".chip-dropdown-wrapper");

  function closeAllDropdowns(except) {
    dropdownWrappers.forEach(w => {
      if (w !== except) {
        w.classList.remove("is-open");
      }
    });
  }

  dropdownWrappers.forEach(wrapper => {
    const toggle = wrapper.querySelector(".chip-dropdown");
    const menu = wrapper.querySelector(".dropdown-menu");
    const hiddenInput = wrapper.querySelector('input[type="hidden"]');
    if (!toggle || !menu || !hiddenInput) return;

    // Open/close on chip click (ignore click on inner "x")
    toggle.addEventListener("click", (ev) => {
      if (ev.target && ev.target.closest(".chip-clear-icon")) return;
      ev.stopPropagation();
      const isOpen = wrapper.classList.contains("is-open");
      closeAllDropdowns(isOpen ? wrapper : null);
      wrapper.classList.toggle("is-open", !isOpen);
    });

    // Click on item
    menu.querySelectorAll(".dropdown-item").forEach(item => {
      item.addEventListener("click", (ev) => {
        ev.stopPropagation();
        const value = item.dataset.value || "";
        hiddenInput.value = value;
        form.submit();
      });
    });
  });

  // Clear via "x" in region/pharmacy/driver chip
  const clearIcons = form.querySelectorAll(".chip-dropdown-wrapper .chip-clear-icon");
  clearIcons.forEach(icon => {
    icon.addEventListener("click", (ev) => {
      ev.stopPropagation();
      const wrapper = icon.closest(".chip-dropdown-wrapper");
      if (!wrapper) return;
      const hiddenInput = wrapper.querySelector('input[type="hidden"]');
      if (!hiddenInput) return;
      hiddenInput.value = "";
      form.submit();
    });
  });

  // Close dropdowns on outside click
  document.addEventListener("click", (ev) => {
    dropdownWrappers.forEach(w => {
      if (!w.contains(ev.target)) {
        w.classList.remove("is-open");
      }
    });
  });
})();

/* ========================= LEAFLET MAP INIT ========================= */
/* Creates an interactive Leaflet map inside each .location-map div
   that has data-lat and data-lng attributes. */
(function() {
  // If Leaflet is not loaded, do nothing (avoids runtime errors)
  if (typeof L === "undefined") {
    console.warn("Leaflet is not available; skipping map initialization.");
    return;
  }

  const mapBlocks = document.querySelectorAll(".location-map[data-lat][data-lng]");
  mapBlocks.forEach((el) => {
    const lat = parseFloat(el.getAttribute("data-lat") || "");
    const lng = parseFloat(el.getAttribute("data-lng") || "");
    if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

    // Create map instance
    const map = L.map(el, {
      center: [lat, lng],
      zoom: 17,
      scrollWheelZoom: false, // default: disabled to avoid accidental page scroll-zoom
      zoomControl: true
    });

    // Modern, clean basemap (CartoDB Voyager)
    L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",
      {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors, ' +
          '&copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: "abcd",
        maxZoom: 19
      }
    ).addTo(map);

    // Custom simple marker
    const markerIcon = L.divIcon({
      className: "custom-marker",
      iconSize: [20, 20],
      iconAnchor: [8, 8]
    });
    L.marker([lat, lng], { icon: markerIcon }).addTo(map);

    // --- Smart scroll behaviour: enable wheel only while cursor is on the map ---

    // Make sure scroll wheel is disabled by default
    map.scrollWheelZoom.disable();

    // Enable scroll zoom when mouse moves over the map
    map.on("mouseover", () => {
      map.scrollWheelZoom.enable();
    });

    // Disable scroll zoom when mouse leaves the map area
    map.on("mouseout", () => {
      map.scrollWheelZoom.disable();
    });

    // Optional: also enable wheel zoom when user clicks the map
    map.on("click", () => {
      map.scrollWheelZoom.enable();
    });
  });
})();


/* ========================= PHOTO LIGHTBOX / CAROUSEL ========================= */
/* Simple lightbox overlay used to view multiple photos in a row as a carousel. */
(function() {
  const lightbox    = document.getElementById("photoLightbox");
  if (!lightbox) return;

  const img         = document.getElementById("lightboxImage");
  const counterNode = document.getElementById("lightboxCounter");
  const btnPrev     = document.getElementById("lightboxPrev");
  const btnNext     = document.getElementById("lightboxNext");
  const btnClose    = document.getElementById("lightboxClose");

  let currentList = [];
  let currentIndex = 0;

  function updateImage() {
    if (!currentList.length) return;
    const pid = currentList[currentIndex];
    img.src = "/pickup/photos/" + pid;
    if (counterNode) {
      counterNode.textContent = (currentIndex + 1) + " / " + currentList.length;
    }
  }

  function openLightbox(list, index) {
    if (!list || !list.length) return;
    currentList = list;
    currentIndex = Math.min(Math.max(index, 0), list.length - 1);
    updateImage();
    lightbox.hidden = false;
    document.body.classList.add("modal-open");
  }

  function closeLightbox() {
    lightbox.hidden = true;
    document.body.classList.remove("modal-open");
  }

  if (btnPrev) {
    btnPrev.addEventListener("click", () => {
      if (!currentList.length) return;
      currentIndex = (currentIndex - 1 + currentList.length) % currentList.length;
      updateImage();
    });
  }

  if (btnNext) {
    btnNext.addEventListener("click", () => {
      if (!currentList.length) return;
      currentIndex = (currentIndex + 1) % currentList.length;
      updateImage();
    });
  }

  if (btnClose) {
    btnClose.addEventListener("click", () => {
      closeLightbox();
    });
  }

  // Close when clicking on backdrop
  lightbox.addEventListener("click", (ev) => {
    if (ev.target === lightbox) {
      closeLightbox();
    }
  });

  // Keyboard navigation
  document.addEventListener("keydown", (ev) => {
    if (lightbox.hidden) return;
    if (ev.key === "Escape") {
      closeLightbox();
    } else if (ev.key === "ArrowRight") {
      btnNext && btnNext.click();
    } else if (ev.key === "ArrowLeft") {
      btnPrev && btnPrev.click();
    }
  });

  // Attach to thumbnails
  const thumbs = document.querySelectorAll(".photo-thumb");
  thumbs.forEach((thumb) => {
    thumb.addEventListener("click", (ev) => {
      ev.preventDefault();
      const pidsStr = thumb.getAttribute("data-pids") || "";
      const indexStr = thumb.getAttribute("data-index") || "0";
      if (!pidsStr) return;

      const list = pidsStr.split(",").map(s => s.trim()).filter(Boolean);
      const idx = parseInt(indexStr, 10) || 0;
      openLightbox(list, idx);
    });
  });
})();

/* ========================= EXPORT FORMAT DROPDOWN ========================= */
/* Small helper for the export format chip: toggles dropdown locally and
   updates hidden "format" input. */
(function() {
  const wrapper = document.querySelector(".export-format-wrapper");
  if (!wrapper) return;

  const chip = wrapper.querySelector(".chip-export");
  const menu = wrapper.querySelector(".dropdown-menu");
  const hiddenInput = wrapper.querySelector('input[name="format"]');
  const labelNode = wrapper.querySelector(".chip-main-text");

  if (!chip || !menu || !hiddenInput || !labelNode) return;

  // Open / close on chip click
  chip.addEventListener("click", (ev) => {
    ev.stopPropagation();
    const isOpen = wrapper.classList.contains("is-open");
    wrapper.classList.toggle("is-open", !isOpen);
  });

  // Click on option
  menu.querySelectorAll(".dropdown-item").forEach(item => {
    item.addEventListener("click", (ev) => {
      ev.stopPropagation();
      const value = item.dataset.value || "csv";

      hiddenInput.value = value;
      labelNode.textContent = (value === "xlsx") ? "Excel (.xlsx)" : "CSV";

      // Active state
      menu.querySelectorAll(".dropdown-item").forEach(i => i.classList.remove("is-active"));
      item.classList.add("is-active");

      wrapper.classList.remove("is-open");
      // No auto-submit – user clicks "Download"
    });
  });

  // Close on outside click
  document.addEventListener("click", (ev) => {
    if (!wrapper.contains(ev.target)) {
      wrapper.classList.remove("is-open");
    }
  });
})();
</script>
{% endblock %}
